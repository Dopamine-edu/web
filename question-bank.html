
<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ডোপামিন - প্রশ্ন ব্যাংক</title>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css?family=Hind+Siliguri');

        :root {
            --bg-color: #f5f5f5;
            --text-color: #333;
            --card-bg: #fff;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --border-color: #ddd;
            --secondary-text-color: #666;
            --purple-box: #9810fa;
            --blue-box: #2b7fff;
            --green-box: #00c950;
            --orange-btn: #F97316;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --card-bg: #2d2d2d;
            --shadow: 0 2px 10px rgba(255, 255, 255, 0.1);
            --border-color: #444;
            --secondary-text-color: #b0b0b0;
            --purple-box: #7C3AED;
            --blue-box: #2563EB;
            --green-box: #16A34A;
            --orange-btn: #EA580C;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Hind Siliguri', sans-serif;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
        }

        .navbar {
            background: var(--card-bg);
            padding: 1rem;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .nav-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--purple-box);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
            transition: transform 0.3s;
        }

        .theme-toggle:hover { transform: scale(1.1); }

        .back-btn {
            background: var(--purple-box);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: #7C3AED;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .section {
            margin-bottom: 3rem;
        }

        .section-title {
            font-size: 2rem;
            font-weight: bold;
            color: var(--purple-box);
            text-align: center;
            margin-bottom: 2rem;
        }

        .category-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .category-card:hover {
            border-color: var(--purple-box);
            transform: translateY(-5px);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-header:hover {
            background: rgba(107, 72, 255, 0.05);
            border-radius: 8px;
            margin: 0 -1rem;
            padding: 1rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .dropdown-arrow {
            font-size: 1.2rem;
            color: var(--purple-box);
            transition: transform 0.3s ease;
        }

        .dropdown-arrow.rotated {
            transform: rotate(180deg);
        }

        .dropdown-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 0;
        }

        .dropdown-content.expanded {
            max-height: 2000px;
            margin-top: 1.5rem;
        }

        .category-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .category-icon {
            font-size: 2rem;
            color: var(--purple-box);
        }

        .category-stats {
            background: var(--purple-box);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: bold;
        }

        .years-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .year-card {
            background: var(--card-bg);
            color: var(--text-color);
            padding: 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            border: 2px solid var(--border-color);
        }

        .year-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            border-color: var(--purple-box);
        }

        .year-card.completed {
            border-color: var(--green-box);
            background: linear-gradient(135deg, var(--card-bg), rgba(0, 201, 80, 0.05));
        }

        .year-card.completed:hover {
            border-color: var(--green-box);
        }

        .year-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 1rem;
            text-align: center;
        }

        .year-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .year-stats span {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .start-exam-btn {
            width: 100%;
            background: var(--purple-box);
            border: 2px solid var(--purple-box);
            color: white;
            padding: 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .start-exam-btn:hover {
            background: #7C3AED;
            border-color: #7C3AED;
            transform: translateY(-1px);
        }

        .retake-exam-btn {
            width: 100%;
            background: var(--orange-btn);
            border: 2px solid var(--orange-btn);
            color: white;
            padding: 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .retake-exam-btn:hover {
            background: #EA580C;
            border-color: #EA580C;
            transform: translateY(-1px);
        }

        .exam-result {
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(0, 201, 80, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--green-box);
        }

        .marks-display {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--green-box);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .result-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .result-stats .correct {
            color: var(--green-box);
            font-weight: bold;
        }

        .result-stats .incorrect {
            color: #dc3545;
            font-weight: bold;
        }

        .result-stats .skipped {
            color: var(--secondary-text-color);
            font-weight: bold;
        }

        .year-title.completed {
            color: var(--green-box);
            position: relative;
        }

        .year-title.completed::after {
            content: "✓";
            position: absolute;
            right: 0;
            top: 0;
            background: var(--green-box);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: var(--secondary-text-color);
        }

        .loading i {
            font-size: 2rem;
            color: var(--purple-box);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 0.5rem;
            }

            .navbar {
                padding: 0.8rem;
                margin: 0 auto;
                width: calc(100% - 1rem);
            }

            .nav-title {
                font-size: 1.2rem;
            }

            .back-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
            }

            .section-title {
                font-size: 1.4rem;
                margin-bottom: 1.5rem;
            }

            .category-card {
                padding: 1rem;
                margin-bottom: 1.5rem;
            }

            .category-title {
                font-size: 1.3rem;
            }

            .category-icon {
                font-size: 1.3rem;
            }

            .category-stats {
                font-size: 0.85rem;
                padding: 0.4rem 0.8rem;
            }

            .header-right {
                gap: 0.5rem;
            }

            .years-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .year-card {
                padding: 1rem;
            }

            .year-title {
                font-size: 1rem;
                margin-bottom: 0.8rem;
            }

            .year-stats {
                font-size: 0.8rem;
                margin-bottom: 0.8rem;
            }

            .start-exam-btn, .retake-exam-btn {
                padding: 0.7rem;
                font-size: 0.9rem;
            }

            .exam-result {
                margin: 0.8rem 0;
                padding: 0.8rem;
            }

            .marks-display {
                font-size: 1rem;
                margin-bottom: 0.4rem;
            }

            .result-stats {
                font-size: 0.8rem;
            }

            .year-title.completed::after {
                width: 20px;
                height: 20px;
                font-size: 0.7rem;
            }
        }

        @media (max-width: 480px) {
            .navbar {
                flex-direction: column;
                gap: 0.8rem;
                align-items: stretch;
            }

            .nav-left {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.8rem;
            }

            .nav-right {
                display: flex;
                justify-content: center;
                gap: 1rem;
            }

            .category-title {
                font-size: 1.1rem;
            }

            .category-icon {
                font-size: 1.1rem;
            }

            .header-right {
                flex-direction: column;
                align-items: flex-end;
                gap: 0.3rem;
            }

            .dropdown-arrow {
                font-size: 1rem;
            }
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-left">
            <img src="logo.png" alt="ডোপামিন" class="logo">
            <div class="nav-title">প্রশ্ন ব্যাংক</div>
        </div>
        <div class="nav-right">
            <button class="theme-toggle" onclick="toggleTheme()">
                <i class="fas fa-moon" id="themeIcon"></i>
            </button>
            <a href="dashboard.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                ড্যাশবোর্ডে ফিরুন
            </a>
        </div>
    </nav>

    <div class="container">
        <h1 class="section-title">প্রশ্ন ব্যাংক</h1>

        <div class="loading" id="loading">
            <i class="fas fa-spinner"></i>
            <p>প্রশ্ন ব্যাংক লোড হচ্ছে...</p>
        </div>

        <!-- Medical Section -->
        <div class="section" id="medicalSection" style="display: none;">
            <div class="category-card">
                <div class="category-header" onclick="toggleDropdown('medical')">
                    <div class="category-title">
                        <i class="fas fa-stethoscope category-icon"></i>
                        মেডিকেল ভর্তি পরীক্ষা
                    </div>
                    <div class="header-right">
                        <div class="category-stats" id="medicalYearCount">
                            ১৪ বছরের প্রশ্ন
                        </div>
                        <i class="fas fa-chevron-down dropdown-arrow" id="medicalArrow"></i>
                    </div>
                </div>
                <div class="dropdown-content" id="medicalDropdown">
                    <div class="years-grid" id="medicalYears">
                        <!-- Medical years will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Dental Section -->
        <div class="section" id="dentalSection" style="display: none;">
            <div class="category-card">
                <div class="category-header" onclick="toggleDropdown('dental')">
                    <div class="category-title">
                        <i class="fas fa-tooth category-icon"></i>
                        ডেন্টাল ভর্তি পরীক্ষা
                    </div>
                    <div class="header-right">
                        <div class="category-stats" id="dentalYearCount">
                            ১৤ বছরের প্রশ্ন
                        </div>
                        <i class="fas fa-chevron-down dropdown-arrow" id="dentalArrow"></i>
                    </div>
                </div>
                <div class="dropdown-content" id="dentalDropdown">
                    <div class="years-grid" id="dentalYears">
                        <!-- Dental years will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBXXaWWoFqn6MpH6IWSm6CGaqUJzAmzbzA",
            authDomain: "dopamine-quiz.firebaseapp.com",
            projectId: "dopamine-quiz",
            storageBucket: "dopamine-quiz.appspot.com",
            messagingSenderId: "822531459966",
            appId: "1:822531459966:web:8e7d2385090e997eb1c12f"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let availableYears = [];

        // Check authentication
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = "auth.html?redirect=" + encodeURIComponent(window.location.href);
            } else {
                loadQuestionBank();
            }
        });

        async function loadQuestionBank() {
            try {
                // Show UI immediately with known years
                showInitialUI();
                
                // Load data in parallel
                const [availableYears, examAttempts] = await Promise.all([
                    loadAvailableYears(),
                    loadExamAttempts()
                ]);
                
                // Render both sections in parallel
                await Promise.all([
                    renderMedicalYears(),
                    renderDentalYears()
                ]);
                
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error loading question bank:', error);
                document.getElementById('loading').innerHTML = '<p>প্রশ্ন ব্যাংক লোড করতে ত্রুটি হয়েছে</p>';
            }
        }

        function showInitialUI() {
            // Show sections immediately with predefined years
            document.getElementById('medicalSection').style.display = 'block';
            document.getElementById('dentalSection').style.display = 'block';
            
            // Set initial year counts
            const initialYears = ['2024-25', '2023-24', '2022-23', '2021-22', '2020-21', '2019-20', '2018-19', '2017-18', '2016-17', '2015-16', '2014-15', '2013-14', '2012-13', '2011-12'];
            document.getElementById('medicalYearCount').textContent = `${initialYears.length} বছরের প্রশ্ন`;
            document.getElementById('dentalYearCount').textContent = `${initialYears.length} বছরের প্রশ্ন`;
        }

        async function loadAvailableYears() {
            try {
                // Use predefined years (we know these exist)
                availableYears = [
                    '2024-25', '2023-24', '2022-23', '2021-22', '2020-21',
                    '2019-20', '2018-19', '2017-18', '2016-17', '2015-16',
                    '2014-15', '2013-14', '2012-13', '2011-12'
                ];

                // Validate years in parallel (much faster)
                const yearChecks = availableYears.map(async (year) => {
                    try {
                        const response = await fetch(`./questions/medical/admission/${year}.json`, {
                            method: 'HEAD' // Only check if file exists, don't download
                        });
                        return response.ok ? year : null;
                    } catch (error) {
                        return null;
                    }
                });

                const validYears = (await Promise.all(yearChecks)).filter(year => year !== null);
                availableYears = validYears.length > 0 ? validYears : availableYears; // Fallback to all years
                
                document.getElementById('medicalYearCount').textContent = `${availableYears.length} বছরের প্রশ্ন`;
                document.getElementById('dentalYearCount').textContent = `${availableYears.length} বছরের প্রশ্ন`;
                
                return availableYears;
            } catch (error) {
                console.error('Error loading available years:', error);
                // Fallback to known years
                availableYears = ['2024-25', '2023-24', '2022-23', '2021-22'];
                document.getElementById('medicalYearCount').textContent = `${availableYears.length} বছরের প্রশ্ন`;
                document.getElementById('dentalYearCount').textContent = `${availableYears.length} বছরের প্রশ্ন`;
                return availableYears;
            }
        }

        // Store exam attempts data
        let examAttempts = {};
        let questionBankAttempts = {};

        async function loadExamAttempts() {
            try {
                const userId = auth.currentUser.uid;
                
                // Single query to get all user attempts (minimizes Firebase reads)
                const attemptsSnapshot = await db.collection('attempts')
                    .where('userId', '==', userId)
                    .get();

                examAttempts = {};
                const examIds = new Set();
                
                attemptsSnapshot.forEach(doc => {
                    const attempt = doc.data();
                    const examId = attempt.examId;
                    examIds.add(examId);
                    
                    // Store the best attempt for each exam
                    if (!examAttempts[examId] || attempt.score > examAttempts[examId].score) {
                        examAttempts[examId] = attempt;
                    }
                });

                // Batch query for exam details (single read for all exams)
                if (examIds.size > 0) {
                    const examPromises = Array.from(examIds).map(examId => 
                        db.collection('exams').doc(examId).get()
                    );
                    
                    const examDocs = await Promise.all(examPromises);
                    
                    examDocs.forEach((examDoc, index) => {
                        if (examDoc.exists) {
                            const examData = examDoc.data();
                            const examId = Array.from(examIds)[index];
                            
                            if (examData.isQuestionBank) {
                                const key = `${examData.examType}-${examData.examYear}`;
                                questionBankAttempts[key] = examAttempts[examId];
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading exam attempts:', error);
                examAttempts = {};
                questionBankAttempts = {};
            }
        }

        // Cache for question counts to avoid repeated file reads
        const questionCountCache = {};

        async function renderMedicalYears() {
            const container = document.getElementById('medicalYears');
            container.innerHTML = '';

            // Load all years in parallel
            const cardPromises = availableYears.map(async (year) => {
                try {
                    const questionCount = await getQuestionCount('medical', year);
                    return createYearCard(year, questionCount, 'medical');
                } catch (error) {
                    console.error(`Error loading medical year ${year}:`, error);
                    return null;
                }
            });

            const cards = await Promise.all(cardPromises);
            cards.forEach(card => {
                if (card) container.appendChild(card);
            });
        }

        async function renderDentalYears() {
            const container = document.getElementById('dentalYears');
            container.innerHTML = '';

            // Load all years in parallel
            const cardPromises = availableYears.map(async (year) => {
                try {
                    const questionCount = await getQuestionCount('dental', year);
                    return createYearCard(year, questionCount, 'dental');
                } catch (error) {
                    console.error(`Error loading dental year ${year}:`, error);
                    return null;
                }
            });

            const cards = await Promise.all(cardPromises);
            cards.forEach(card => {
                if (card) container.appendChild(card);
            });
        }

        async function getQuestionCount(examType, year) {
            const cacheKey = `${examType}-${year}`;
            
            if (questionCountCache[cacheKey]) {
                return questionCountCache[cacheKey];
            }

            try {
                const response = await fetch(`./questions/${examType}/admission/${year}.json`);
                if (response.ok) {
                    const questions = await response.json();
                    const count = questions.length;
                    questionCountCache[cacheKey] = count;
                    return count;
                }
                return 0;
            } catch (error) {
                console.error(`Error getting question count for ${cacheKey}:`, error);
                return 0;
            }
        }

        function createYearCard(year, questionCount, examType) {
            const card = document.createElement('div');
            card.className = 'year-card';
            
            // Check if user has attempted this exam using cached data
            const examKey = `${examType}-${year}`;
            const attempt = questionBankAttempts[examKey] || null;

            let cardContent;
            if (attempt) {
                // User has attempted this exam
                const totalMarks = questionCount * 1; // 1 mark per question
                const percentage = Math.round((attempt.score / totalMarks) * 100);
                
                cardContent = `
                    <h3 class="year-title completed">${year}</h3>
                    <div class="year-stats">
                        <span><i class="fas fa-question-circle"></i> ${questionCount} প্রশ্ন</span>
                        <span><i class="fas fa-clock"></i> ৬০ মিনিট</span>
                    </div>
                    <div class="exam-result">
                        <div class="marks-display">
                            <i class="fas fa-trophy"></i> 
                            স্কোর: ${attempt.score}/${totalMarks} (${percentage}%)
                        </div>
                        <div class="result-stats">
                            <span class="correct">✓ ${attempt.correctAnswers}</span>
                            <span class="incorrect">✗ ${attempt.incorrectAnswers}</span>
                            <span class="skipped">− ${attempt.skippedAnswers}</span>
                        </div>
                    </div>
                    <button class="retake-exam-btn" onclick="startExam('${year}', '${examType}')">
                        <i class="fas fa-redo"></i> পুনরায় দিন
                    </button>
                `;
                card.classList.add('completed');
            } else {
                // User has not attempted this exam
                cardContent = `
                    <h3 class="year-title">${year}</h3>
                    <div class="year-stats">
                        <span><i class="fas fa-question-circle"></i> ${questionCount} প্রশ্ন</span>
                        <span><i class="fas fa-clock"></i> ৬০ মিনিট</span>
                    </div>
                    <button class="start-exam-btn" onclick="startExam('${year}', '${examType}')">
                        <i class="fas fa-play"></i> পরীক্ষা শুরু করুন
                    </button>
                `;
            }

            card.innerHTML = cardContent;
            return card;
        }

        async function startExam(year, examType) {
            try {
                // Create a question bank exam
                const examData = {
                    title: `${examType === 'medical' ? 'মেডিকেল' : 'ডেন্টাল'} ভর্তি পরীক্ষা - ${year}`,
                    duration: 60,
                    marksPerQuestion: 1,
                    negativeMark: 0.25,
                    isQuestionBank: true,
                    examType: examType,
                    examYear: year,
                    createdBy: auth.currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                const docRef = await db.collection('exams').add(examData);
                window.location.href = `quiz.html?examId=${docRef.id}`;
            } catch (error) {
                console.error('Error starting exam:', error);
                alert('পরীক্ষা শুরু করতে ত্রুটি হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।');
            }
        }

        // Dropdown toggle functionality
        function toggleDropdown(section) {
            const dropdown = document.getElementById(`${section}Dropdown`);
            const arrow = document.getElementById(`${section}Arrow`);
            
            dropdown.classList.toggle('expanded');
            arrow.classList.toggle('rotated');
        }

        // Theme toggle functionality
        let isDark = localStorage.getItem('theme') === 'dark';
        if (isDark) {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('themeIcon').classList.replace('fa-moon', 'fa-sun');
        }

        function toggleTheme() {
            isDark = !isDark;
            document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
            document.getElementById('themeIcon').classList.toggle('fa-moon');
            document.getElementById('themeIcon').classList.toggle('fa-sun');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }
    </script>
</body>
</html>
